<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <title>Agente de Vendas com IA</title>
  <style>
    body {
      font-family: Arial;
      padding: 20px;
    }

    #chat {
      border: 1px solid #ccc;
      padding: 10px;
      height: 300px;
      overflow-y: scroll;
    }

    .msg {
      margin: 5px 0;
    }

    .user {
      font-weight: bold;
    }

    .bot {
      color: green;
    }
  </style>
</head>

<body>
  <h2>Agente de Vendas com IA (via OpenRouter)</h2>
  <div id="chat"></div>
  <input type="text" id="userInput" placeholder="Digite sua mensagem..." style="width: 80%;">
  <button onclick="sendMessage()">Enviar</button>

  <script>
    const apiKey = "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"; // Substitua por sua chave
    const chatDiv = document.getElementById("chat");

    let chatHistory = [
      { role: "system", content: "Voc√™ √© um assistente de vendas amig√°vel. Pergunte nome, endere√ßo e produtos desejados. Quando tiver tudo, diga 'Obrigado, os dados foram confirmados!'." }
    ];

    // Dados do cliente coletados
    let userData = {
      name: null,
      address: null,
      products: null
    };

    let expectingConfirmation = false; // Controle de confirma√ß√£o

    function appendMessage(sender, text) {
      const msg = document.createElement("div");
      msg.className = "msg " + (sender === "user" ? "user" : "bot");
      msg.innerHTML = `<strong>${sender === "user" ? "Voc√™" : "IA"}:</strong> ${text}`;
      chatDiv.appendChild(msg);
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    async function extractDataWithAIFromFullHistory(historyText) {
      try {
        const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${apiKey}`,
            "X-Title": "extrator-de-dados"
          },
          body: JSON.stringify({
            model: "meta-llama/llama-4-scout:free",
            messages: [
              {
                role: "system",
                content: `Voc√™ √© um extrator de informa√ß√µes. A partir do hist√≥rico da conversa abaixo, extraia os seguintes campos:

{
  "nome": "extraia o nome do cliente se dispon√≠vel",
  "endereco": "extraia o endere√ßo do cliente se dispon√≠vel",
  "produtos": "extraia os produtos ou servi√ßos mencionados pelo cliente"
}

Retorne APENAS o JSON com os campos preenchidos quando poss√≠vel.`
              },
              {
                role: "user",
                content: historyText
              }
            ],
            temperature: 0.2,
            max_tokens: 300
          })
        });

        const data = await response.json();
        const extractedText = data.choices[0].message.content.trim();

        let extractedData = {};
        try {
          extractedData = JSON.parse(extractedText);
        } catch (e) {
          console.error("Falha ao analisar JSON:", extractedText);
          return {};
        }

        return extractedData;

      } catch (error) {
        console.error("Erro na extra√ß√£o com IA:", error);
        return {};
      }
    }

    async function sendMessage() {
      const input = document.getElementById("userInput");
      const userText = input.value.trim();
      if (!userText) return;

      appendMessage("user", userText);
      chatHistory.push({ role: "user", content: userText });
      input.value = "";

      try {
        // Passo 1: Obter resposta do bot
        const chatResponse = await fetch("https://openrouter.ai/api/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${apiKey}`,
            "X-Title": "agente-de-vendas-ia"
          },
          body: JSON.stringify({
            model: "meta-llama/llama-4-scout:free",
            messages: chatHistory,
            temperature: 0.7
          })
        });

        const chatData = await chatResponse.json();
        const botReply = chatData.choices[0].message.content.trim();

        appendMessage("bot", botReply);
        chatHistory.push({ role: "assistant", content: botReply });

        // Verifica se o bot j√° perguntou pela confirma√ß√£o
        if (expectingConfirmation) {
          const lowerText = userText.toLowerCase();
          if (lowerText.includes("sim") || lowerText.includes("confirmo")) {
            // Monta o hist√≥rico como texto
            const historyText = chatHistory.map(msg => `${msg.role === "user" ? "Usu√°rio" : "Assistente"}: ${msg.content}`).join("\n");

            // Extrai dados com IA usando o hist√≥rico completo
            const extracted = await extractDataWithAIFromFullHistory(historyText);

            if (extracted.nome || extracted.endereco || extracted.produtos) {
              userData = {
                name: extracted.nome || "N√£o informado",
                address: extracted.endereco || "N√£o informado",
                products: extracted.produtos || "N√£o informado"
              };

              const confirmationMsg = `Os dados foram confirmados!\nNome: ${userData.name}\nEndere√ßo: ${userData.address}\nProdutos: ${userData.products}`;
              appendMessage("bot", confirmationMsg);

              console.log("üì¶ DADOS DO CLIENTE:");
              console.log("Nome:", userData.name);
              console.log("Endere√ßo:", userData.address);
              console.log("Produtos:", userData.products);
            } else {
              appendMessage("bot", "N√£o consegui extrair os dados com clareza. Voc√™ pode repetir as principais informa√ß√µes?");
            }

            expectingConfirmation = false;
          } else {
            appendMessage("bot", "Entendi. Caso precise alterar algo, me avise!");
            expectingConfirmation = false;
          }
        } else {
          // Verificar se o bot j√° solicitou todas as informa√ß√µes
          const hasAllFields = botReply.toLowerCase().includes("obrigado") ||
                               botReply.toLowerCase().includes("dados completos");

          if (hasAllFields) {
            appendMessage("bot", "Voc√™ confirma os dados fornecidos?");
            expectingConfirmation = true;
          }
        }

      } catch (error) {
        console.error("Erro durante envio:", error);
      }
    }
  </script>
</body>

</html>